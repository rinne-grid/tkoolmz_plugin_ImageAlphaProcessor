# ImageAlphaProcessor プラグイン

## 概要
画像生成AIで作成されたJPEG画像の背景を透明化し、擬似的なアルファチャンネルを実現するプラグインです。単体での透過処理に加え、フォルダ内画像の一括バッチ処理機能も提供します。

画像の透過処理が面倒くさすぎたので、「こんなのあったらいいな」と思ってお願いしました。

> **実装について**: このプラグインは**Claude Sonnet 4によるVibe Coding**で実装されました。

## 機能
- **擬似的アルファチャンネル処理**: 単色背景のJPEG画像を透過PNG化
- **バッチ処理**: フォルダ内の複数画像を一括処理
- **ブラウザベース**: Live Server等でindex.htmlを起動して使用
- **フォルダ選択**: converter_sourceフォルダを選択して処理実行
- **自動ダウンロード**: 処理済みPNGファイルを自動ダウンロード

> **注意**: 画像品質は実験的なプラグインのため粗めです。

## クイックスタート

### 1. 環境準備
1. Live Server等のローカルサーバーで `index.html` を起動
2. `converter_source` フォルダに処理したいJPEG画像を配置

### 2. バッチ処理の実行
1. ブラウザでサイトにアクセス
2. フォルダ選択ダイアログで `converter_source` を選択
3. 処理が自動実行され、ブラウザのデフォルトダウンロード先にPNGファイルが保存

### 3. 推奨設定
- **緑背景（グリーンバック）**: スレッショルド値 **95** 程度が良さそう
- **その他の背景色**: 色に応じて閾値を調整

> **注意**: 現在は緑背景でのテストのみ実施済みです。他の背景色については理論値のため、実際の使用時は調整が必要な場合があります。

## 擬似的アルファチャンネル処理

### 画像生成AI用推奨プロンプト（Nano Banana等）

緑背景で透過処理に最適な画像を生成するための推奨プロンプト：

```
ファンタジーの主人公キャラクター({男の子} or {女の子})を描く。絵柄は日本のアニメを彷彿とさせる萌の美学とする。
- 正面向き、両手を自然に体側に下ろした立ちポーズ
- 顔立ちや髪型は今後の衣装差分でも必ず同一にしてください
- キャラクターは鮮やかなフルカラーで描写すること
- 背景は #00FF00 の単色で塗りつぶし、キャラクターの身体的特徴（肌、髪、瞳など）や衣装、小物などにはこの色を絶対に使用しない
- 後処理で透過処理を行うため、背景以外にこの色を使わないこと
```

> **重要**: 背景色（#00FF00）をキャラクター部分に使用しないことが透過処理成功の鍵です。

### 対応背景色
| 背景色 | 推奨閾値 | 用途 | テスト状況 |
|--------|----------|------|------------|
| **緑色** | 95 | グリーンバック撮影 | **✅ 検証済み。でも荒いかも** |
| 白色 | 8 | AI生成画像の一般的背景 | ⚠️ 理論値 |
| 赤色 | 12 | 赤背景スタジオ撮影 | ⚠️ 理論値 |
| 青色 | 12 | ブルーバック撮影 | ⚠️ 理論値 |
| 黒色 | 15 | 暗背景での撮影 | ⚠️ 理論値 |

### JavaScript API使用例

```javascript
// 基本的な白背景透過
const transparentBitmap = await loadJpegPseudoAlphaChannel('img/pictures/example.jpg');

// 緑背景透過（グリーンバック推奨設定）
const greenBg = await loadJpegGreenBackgroundTransparent('img/characters/hero_green.jpg', {
  threshold: 95,      // 緑背景に最適化
  featherRadius: 2.0  // エッジを滑らかに
});

// カスタム設定での透過処理
const customBg = await loadJpegPseudoAlphaChannel('img/test.jpg', {
  threshold: 95,       // Lab色差閾値
  smooth: true,        // スムージング有効
  featherRadius: 2.0   // フェザー半径
});
```

## バッチ処理機能

### 基本的なバッチ処理

```javascript
// 全ファイル一括処理
const result = await ImageBatchProcessor.convertAll({
  threshold: 95,       // 緑背景用推奨値
  smooth: true,        // スムージング有効
  featherRadius: 2.0,  // フェザー半径
  preset: 'green'      // プリセット指定
});

// 処理状況の確認
const status = ImageBatchProcessor.getBatchState();
console.log('処理中:', status.isProcessing);
console.log('進捗:', status.processedCount, '/', status.totalFiles);
```

### プリセット処理
色別の最適化された設定で一括処理：

| プリセット | 対象色 | 推奨閾値 | 特徴 |
|-----------|--------|----------|------|
| **green** | #00FF00 | **95** | **グリーンバック撮影（推奨）** |
| white | #FFFFFF | 8 | AI生成画像の標準背景 |
| red | #FF0000 | 12 | 赤系背景スタジオ |
| blue | #0000FF | 12 | ブルーバック撮影 |
| black | #000000 | 15 | 暗背景撮影 |
| auto | 自動検出 | 8 | 四隅サンプリング方式 |

```javascript
// 緑背景一括処理（推奨）
const greenResult = await ImageBatchProcessor.convertWithPreset('green', {
  threshold: 95  // 緑背景に最適化
});
```

## プラグインコマンド

### batchConvert
基本的なバッチ処理を実行します。

**推奨引数（緑背景用）:**
- `threshold`: **95** (Lab色差閾値)
- `smooth`: **true** (スムージング有効)
- `featherRadius`: **2.0** (フェザー半径)
- `preset`: **green** (緑背景プリセット)

### batchConvertPreset
指定した色プリセットでバッチ処理を実行します。

**引数:**
- `preset`: 色プリセット（**green推奨**）

### batchStatus
現在のバッチ処理状況を確認します。

### clearCache
処理済みファイルのキャッシュをクリアします。

## 技術仕様

### 擬似的アルファチャンネルの仕組み
1. **色差計算**: Lab色空間での Delta E 計算
2. **エッジ検出**: Sobel オペレータによる境界検出
3. **スムージング**: ガウシアンフィルタによるエッジ平滑化
4. **フェザリング**: アルファ値のグラデーション処理

### 処理フロー
```
JPEG画像 → 色差解析 → エッジ検出 → スムージング → フェザリング → 透過PNG
```

### パフォーマンス特性
- **処理速度**: 中程度（品質重視設計）
- **メモリ使用量**: Canvas API利用により適度
- **品質**: 実験的レベル（個人用途向け）

## パラメータ設定

| パラメータ | 説明 | 推奨値（緑背景） | デフォルト値 |
|-----------|------|------------------|-------------|
| threshold | Lab色差閾値 | **95** | 8 |
| smooth | スムージング有効 | **true** | true |
| featherRadius | フェザー半径 | **2.0** | 1.5 |
| sourceDirectory | ソースディレクトリ名 | - | converter_source |
| outputDirectory | 出力ディレクトリ名 | - | converter_dist |
| autoDownload | 自動ダウンロード有効 | **true** | true |
| maxFiles | 最大処理ファイル数 | - | 20 |

## ファイル検索機能

### File System Access API対応
Chrome等の対応ブラウザでは、File System Access APIを使用してディレクトリを直接選択できます。

### フォールバック機能
API非対応の場合は、事前定義されたファイル名パターンで検索を行います：
- sample1.jpg, sample2.jpg, ...
- character1.jpg, character2.jpg, ...
- ai_generated1.jpg, stable_diffusion.jpg, ...
- その他多数のパターン

## 対応ファイル形式・性能
- **入力**: JPEG (.jpg, .jpeg)
- **出力**: PNG (透過情報付き)
- **最大処理数**: 20ファイル/バッチ（設定変更可能）
- **進捗表示**: リアルタイム処理状況表示
- **エラーログ**: 詳細ログ記録機能

## トラブルシューティング

### 画質について
自分用の作業改善や実験的実装のため、画像品質が粗いです。

### テスト状況について
**現在は緑背景（グリーンバック）でのテストのみ実施済み**です。他の背景色の設定値は理論値であり、実際の使用時は画像に応じた調整が必要になる場合があります。

### 緑背景の最適設定
- **推奨閾値**: 95（Lab色差）
- **スムージング**: 有効
- **フェザー半径**: 2.0

### よくある問題と解決方法

#### エラー: "ImageAlphaProcessor.js プラグインが読み込まれていません"
**解決方法**: ImageAlphaProcessor.js を先に有効にしてください。

#### ファイルが見つからない
**解決方法**: 
1. converter_sourceフォルダが存在することを確認
2. ファイル名が対応パターンに含まれているか確認
3. File System Access API を使用してディレクトリを手動選択

#### 処理が重い・遅い
**解決方法**:
1. maxFiles パラメータを小さく設定
2. 大きな画像ファイルの場合は事前にリサイズ
3. smooth を false に設定してスムージングを無効化

#### ダウンロードされない
**解決方法**:
1. autoDownload パラメータが true になっているか確認
2. ブラウザのダウンロード設定を確認
3. ポップアップブロッカーを無効化

## 開発状況
このプラグインは個人の実験的プロジェクトです。気が向いた時に細々と改善を行う予定ですが、定期的なアップデートは保証されません。

### 実装について
- **開発手法**: Claude Sonnet 4による**Vibe Coding**で実装
- **AI活用**: プログラムコード生成、アルゴリズム設計、このREADME作成にも生成AI（Claude）を活用
- **技術背景**: 作者は画像処理の専門知識を持たないため、Lab色空間やSobelオペレータなどの高度なアルゴリズムは生成AIの支援により実現されました

## ライセンス
このプラグインはMIT ライセンスの下で提供されています。
